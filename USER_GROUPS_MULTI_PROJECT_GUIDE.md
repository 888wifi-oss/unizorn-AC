# User Groups Multi-Project Support - ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠

## ‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Multi-Project ‡πÅ‡∏•‡πâ‡∏ß!

### üéØ **‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:**

**Before (‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏î‡∏¥‡∏°):**
```
User: ‡∏ô‡∏≤‡∏¢ A
  ‚îî‚îÄ Groups: [Accountant, Committee]
  
‡∏õ‡∏±‡∏ç‡∏´‡∏≤:
  ‚ùå Groups ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å Project
  ‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡πà‡∏≤‡∏á Project
  ‚ùå ‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô
```

**After (‡πÅ‡∏Å‡πâ‡πÅ‡∏•‡πâ‡∏ß):**
```
User: ‡∏ô‡∏≤‡∏¢ A
  ‚îú‚îÄ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ X
  ‚îÇ   ‚îú‚îÄ Role: Project Admin
  ‚îÇ   ‚îî‚îÄ Groups: [Accountant, Committee]
  ‚îÇ
  ‚îú‚îÄ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Y
  ‚îÇ   ‚îú‚îÄ Role: Staff  
  ‚îÇ   ‚îî‚îÄ Groups: [Support Staff]
  ‚îÇ
  ‚îî‚îÄ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Z
      ‚îú‚îÄ Role: Resident
      ‚îî‚îÄ Groups: []

‚úÖ ‡πÅ‡∏ï‡πà‡∏•‡∏∞ Project ‡∏°‡∏µ Groups ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô
‚úÖ User ‡∏≠‡∏¢‡∏π‡πà Groups ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ Project
‚úÖ Permissions ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° Project
```

---

## üèóÔ∏è **‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á:**

### **1. Database Changes**

#### **‡πÄ‡∏û‡∏¥‡πà‡∏° `project_id` ‡πÉ‡∏ô `user_group_members`**
```sql
ALTER TABLE public.user_group_members 
ADD COLUMN project_id UUID REFERENCES public.projects(id);
```

#### **Unique Constraint ‡πÉ‡∏´‡∏°‡πà**
```sql
-- ‡πÄ‡∏î‡∏¥‡∏°: (user_group_id, user_id)
-- ‡πÉ‡∏´‡∏°‡πà: (user_group_id, user_id, project_id)

UNIQUE (user_group_id, user_id, project_id)
```

**‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢:**
- User ‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ô‡∏•‡∏∞ Project ‡πÑ‡∏î‡πâ!

---

### **2. Helper Functions**

#### **`get_user_groups_in_project(user_id, project_id)`**
```sql
-- ‡∏î‡∏∂‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á User ‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô
SELECT get_user_groups_in_project(
  '00000000-0000-0000-0000-000000000004',  -- User ID
  '00000000-0000-0000-0000-000000000020'   -- Project ID
);

Returns:
  - group_id
  - group_name
  - group_display_name
```

#### **`get_user_group_permissions_in_project(user_id, project_id)`**
```sql
-- ‡∏î‡∏∂‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á User ‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Union)
SELECT get_user_group_permissions_in_project(
  '00000000-0000-0000-0000-000000000004',
  '00000000-0000-0000-0000-000000000020'
);

Returns:
  - module
  - can_access (bool_or)
  - can_view (bool_or)
  - can_add (bool_or)
  ...
```

#### **`user_has_group_permission_in_project(user_id, project_id, module, action)`**
```sql
-- ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ User ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
SELECT user_has_group_permission_in_project(
  '00000000-0000-0000-0000-000000000004',
  '00000000-0000-0000-0000-000000000020',
  'billing',
  'add'
);

Returns: true/false
```

---

### **3. View: `v_user_group_memberships`**

```sql
-- View ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Query ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡πà‡∏≤‡∏¢ ‡πÜ
SELECT * FROM v_user_group_memberships;

Returns:
  - user_id, email, full_name
  - group_id, group_name, group_display_name
  - project_id, project_name
  - company_id, company_name
  - is_active, created_at
```

---

### **4. Server Actions (Updated)**

#### **`addUserToGroup(userId, groupId, targetUserId, projectId?)`**
```typescript
// ‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏û‡∏¥‡πà‡∏° parameter projectId
await addUserToGroup(
  currentUserId,
  groupId,
  targetUserId,
  projectId  // ‚úÖ NEW
)
```

#### **`bulkAddUsersToGroup(userId, groupId, userIds, projectId?)`**
```typescript
// ‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏û‡∏¥‡πà‡∏° parameter projectId
await bulkAddUsersToGroup(
  currentUserId,
  groupId,
  [user1, user2, user3],
  projectId  // ‚úÖ NEW
)
```

#### **`getUserGroupsInProject(userId, targetUserId, projectId)`**
```typescript
// ‡πÉ‡∏´‡∏°‡πà: ‡∏î‡∏∂‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á User ‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô
const result = await getUserGroupsInProject(
  currentUserId,
  targetUserId,
  projectId
)

// Returns: { success: true, groups: [...] }
```

#### **`getUserGroupPermissionsInProject(userId, targetUserId, projectId)`**
```typescript
// ‡πÉ‡∏´‡∏°‡πà: ‡∏î‡∏∂‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á User ‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
const result = await getUserGroupPermissionsInProject(
  currentUserId,
  targetUserId,
  projectId
)

// Returns: { success: true, permissions: [...] }
```

---

### **5. UI Changes**

#### **Project Selector**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£                         ‚îÇ
‚îÇ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: [Demo Project ‚ñº]           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### **Header ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£**
```
Before:
  ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
  ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°

After:
  ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
  ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£: Demo Project  ‚Üê ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
```

#### **Tab ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£**
```
Before:
  [‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (4)]

After:
  [‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ (4)]  ‚Üê ‡πÄ‡∏ô‡πâ‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ
```

---

## üöÄ **‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:**

### **1. ‡∏£‡∏±‡∏ô SQL Migration**

```sql
-- ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Supabase Dashboard > SQL Editor
-- ‡∏£‡∏±‡∏ô scripts/015_user_groups_multi_project.sql

‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° project_id column
‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï existing data
‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á indexes
‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á helper functions
‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á view
```

### **2. ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤ User Groups**

```
1. Login ‡πÄ‡∏õ‡πá‡∏ô Super Admin / Company Admin / Project Admin
2. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"
3. ‚úÖ ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏´‡πá‡∏ô "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£" card ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
```

### **3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£**

```
1. ‡∏Ñ‡∏•‡∏¥‡∏Å Dropdown "‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£"
2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "Demo Project"
3. ‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô
```

### **4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£**

```
1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô
2. ‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà" ‡∏´‡∏£‡∏∑‡∏≠ ‡πÅ‡∏ó‡πá‡∏ö "‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥"
3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°
4. ‚úÖ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
```

### **5. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£**

```
1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°
3. ‡∏Ñ‡∏•‡∏¥‡∏Å [üë•] "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å"
4. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å User ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°
5. ‚úÖ User ‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ
```

---

## üìä **‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Use Cases:**

### **Case 1: User ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£**

```
User: ‡∏ô‡∏≤‡∏¢ A (Email: a@example.com)

‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ X (Condo A):
  ‚îú‚îÄ Role: Project Admin
  ‚îú‚îÄ Groups: [Accountant, Committee]
  ‚îî‚îÄ Permissions:
      - Accountant: ‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•, ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
      - Committee: ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô

‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Y (Condo B):
  ‚îú‚îÄ Role: Staff
  ‚îú‚îÄ Groups: [Support Staff]
  ‚îî‚îÄ Permissions:
      - Support Staff: ‡∏û‡∏±‡∏™‡∏î‡∏∏, ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°

‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Z (Condo C):
  ‚îú‚îÄ Role: Resident
  ‚îú‚îÄ Groups: []
  ‚îî‚îÄ Permissions:
      - (Base Role only): ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏ô‡πÄ‡∏≠‡∏á

‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:
  ‚úÖ ‡∏ô‡∏≤‡∏¢ A ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
  ‚úÖ Login ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á 3 ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
  ‚úÖ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á account ‡∏ã‡πâ‡∏≥
```

---

### **Case 2: ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ô‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£**

```
‡∏Å‡∏•‡∏∏‡πà‡∏°: "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ"

‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ X:
  - Members: [‡∏ô‡∏≤‡∏¢ A, ‡∏ô‡∏≤‡∏¢ B, ‡∏ô‡∏≤‡∏¢ C]

‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Y:
  - Members: [‡∏ô‡∏≤‡∏¢ A, ‡∏ô‡∏≤‡∏¢ D]

‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Z:
  - Members: [‡∏ô‡∏≤‡∏¢ E, ‡∏ô‡∏≤‡∏¢ F]

‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:
  ‚úÖ ‡∏ô‡∏≤‡∏¢ A ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" ‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ X ‡πÅ‡∏•‡∏∞ Y
  ‚úÖ ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô
  ‚úÖ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô (‡∏à‡∏≤‡∏Å Group config)
```

---

### **Case 3: Permission Calculation**

```
User: ‡∏ô‡∏≤‡∏¢ A
Project: ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ X

Base Role: Staff
  ‚îî‚îÄ Permissions: ‡∏î‡∏π‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î, ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®, ...

Groups in Project X:
  ‚îú‚îÄ Accountant
  ‚îÇ   ‚îî‚îÄ Permissions: ‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•, ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
  ‚îî‚îÄ Committee
      ‚îî‚îÄ Permissions: ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô

Final Permissions (Union):
  = Base Role + Accountant + Committee
  = ‡∏î‡∏π‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î, ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®, ‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•, ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö, 
    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢, ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô

‚úÖ ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á
```

---

## üß™ **‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö:**

### **Test 1: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô**
```
1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ X
2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ"
3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Y
4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ"
5. ‚úÖ ‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô 2 ‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏Ñ‡∏ô‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£)
```

### **Test 2: ‡πÄ‡∏û‡∏¥‡πà‡∏° User ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£**
```
1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ X
2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ"
3. ‡πÄ‡∏û‡∏¥‡πà‡∏° "‡∏ô‡∏≤‡∏¢ A"
4. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Y
5. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° "‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ"
6. ‡πÄ‡∏û‡∏¥‡πà‡∏° "‡∏ô‡∏≤‡∏¢ A"
7. ‚úÖ ‡∏ô‡∏≤‡∏¢ A ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á 2 ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
```

### **Test 3: Permission ‡∏ï‡πà‡∏≤‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£**
```
1. Query: get_user_group_permissions_in_project(‡∏ô‡∏≤‡∏¢ A, ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ X)
2. Query: get_user_group_permissions_in_project(‡∏ô‡∏≤‡∏¢ A, ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Y)
3. ‚úÖ ‡∏Ñ‡∏ß‡∏£‡πÑ‡∏î‡πâ Permissions ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô
```

---

## üìÅ **‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï:**

1. **SQL Migration:**
   - `scripts/015_user_groups_multi_project.sql` ‚úÖ

2. **Server Actions:**
   - `lib/actions/user-group-actions.ts`
     - Updated: `addUserToGroup()`, `bulkAddUsersToGroup()`
     - Added: `getUserGroupsInProject()`, `getUserGroupPermissionsInProject()`

3. **UI:**
   - `app/(admin)/user-groups/page.tsx`
     - Added: Project Selector
     - Updated: Load groups per project
     - Updated: Create/Assign with project_id

4. **Documentation:**
   - `USER_GROUPS_MULTI_PROJECT_GUIDE.md` ‚úÖ

---

## üîê **Security Considerations:**

### **Project Isolation**
```sql
-- RLS ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ User ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

CREATE POLICY "Users can only see their project groups"
ON user_group_members
FOR SELECT
USING (
  project_id IN (
    SELECT project_id 
    FROM user_roles 
    WHERE user_id = auth.uid()
  )
);
```

### **Permission Calculation**
```typescript
// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô Server Actions
async function checkUserPermissionInProject(
  userId: string,
  projectId: string,
  module: string,
  action: string
) {
  // 1. Get base role permissions
  const basePerms = await getBaseRolePermissions(userId, projectId)
  
  // 2. Get group permissions
  const groupPerms = await getUserGroupPermissionsInProject(userId, projectId)
  
  // 3. Merge (Union)
  const finalPerms = mergePermissions(basePerms, groupPerms)
  
  // 4. Check
  return finalPerms[module]?.[action] === true
}
```

---

## üéâ **‡∏™‡∏£‡∏∏‡∏õ:**

### **‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î:**
```
‚ùå Groups ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å Project
‚ùå User ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å Project
‚ùå ‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô
```

### **‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î:**
```
‚úÖ Groups ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° Project
‚úÖ User ‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢ Project, ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô
‚úÖ Permissions ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πà‡∏≠ Project
‚úÖ Flexible & Scalable
‚úÖ Multi-Tenancy Ready
```

**‡∏£‡∏∞‡∏ö‡∏ö User Groups ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Multi-Project ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! üöÄ**

---

## ‚ùì FAQ

**Q: ‡∏ñ‡πâ‡∏≤ User ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏•‡∏≤‡∏¢ Group ‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ß?**  
A: Permissions ‡∏à‡∏∞‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô (Union) ‚Üí ‡πÑ‡∏î‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô

**Q: ‡∏ñ‡πâ‡∏≤ User ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏•‡∏≤‡∏¢ Project?**  
A: ‡πÅ‡∏ï‡πà‡∏•‡∏∞ Project ‡∏°‡∏µ Permissions ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô

**Q: Base Role + Groups = ?**  
A: Permissions ‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô (Union)

**Q: ‡∏•‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏ô Project A ‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏±‡∏ö Project B ‡πÑ‡∏´‡∏°?**  
A: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏• ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô‡πÇ‡∏î‡∏¢‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏ä‡∏¥‡∏á

**‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢! üéØ**
