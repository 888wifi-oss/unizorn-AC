# User Groups - คู่มือการใช้งานระบบกลุ่มผู้ใช้งาน

## ✅ ระบบ User Groups พร้อมใช้งานแล้ว!

### 🎯 **วัตถุประสงค์:**
จัดการกลุ่มผู้ใช้งานและกำหนดสิทธิ์แบบกลุ่ม เพื่อให้สะดวกในการมอบหมายสิทธิ์ให้ผู้ใช้ที่มีหน้าที่คล้ายกัน

---

## 📊 ระบบ User Groups คืออะไร?

### **Before (ไม่มี User Groups):**
```
เพิ่มเจ้าหน้าที่บัญชี 5 คน
  → ต้องตั้งสิทธิ์ทีละคน (เลือกโมดูล 9 ตัว × 5 คน = 45 การตั้งค่า)
  → ถ้าต้องการแก้สิทธิ์ → แก้ 5 คนทีละคน
  → เสียเวลา + เสี่ยงผิดพลาด ❌
```

### **After (มี User Groups):**
```
สร้างกลุ่ม "เจ้าหน้าที่บัญชี" 1 กลุ่ม
  → กำหนดสิทธิ์ 9 โมดูลให้กลุ่ม
  → เพิ่มสมาชิก 5 คนเข้ากลุ่ม
  → ทุกคนได้สิทธิ์เดียวกันทันที ✅
  
แก้ไขสิทธิ์กลุ่ม 1 ครั้ง
  → ทุกคนในกลุ่มได้สิทธิ์ใหม่ทันที ✅
```

---

## 🎨 หน้า User Groups Management

### **ที่อยู่:** `/user-groups`

### **เข้าได้โดย:**
- ✅ Super Admin
- ✅ Company Admin
- ✅ Project Admin
- ❌ Staff (ไม่เห็นเมนู)
- ❌ Engineer (ไม่เห็นเมนู)
- ❌ Resident (ไม่เห็นเมนู)

### **UI Layout:**

```
┌──────────────────────────────────────────────────────────┐
│ กลุ่มผู้ใช้งาน                      [รีเฟรช][สร้างกลุ่ม]│
│ จัดการกลุ่มผู้ใช้และกำหนดสิทธิ์แบบกลุ่ม                │
├──────────────────────────────────────────────────────────┤
│ [กลุ่มทั้งหมด (4)] [กลุ่มแนะนำ]                        │
├──────────────────────────────────────────────────────────┤
│                                                           │
│ รายการกลุ่มผู้ใช้งาน                                     │
│                                                           │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ ชื่อกลุ่ม         │ คำอธิบาย    │ สมาชิก │ จัดการ  │ │
│ ├─────────────────────────────────────────────────────┤ │
│ │ เจ้าหน้าที่บัญชี  │ ฝ่ายบัญชี... │ 3 คน  │[👥][🛡][✏][🗑]││
│ │ กรรมการอาคาร      │ ดูรายงาน... │ 5 คน  │[👥][🛡][✏][🗑]││
│ │ ผู้ตรวจสอบบัญชี   │ งบการเงิน.. │ 1 คน  │[👥][🛡][✏][🗑]││
│ │ เจ้าหน้าที่ทั่วไป│ พัสดุ/ซ่อม.. │ 7 คน  │[👥][🛡][✏][🗑]││
│ └─────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────┘

**ปุ่มจัดการ:**
- [👥] - จัดการสมาชิก
- [🛡] - กำหนดสิทธิ์
- [✏] - แก้ไขกลุ่ม
- [🗑] - ลบกลุ่ม
```

---

## 🚀 วิธีใช้งาน

### **1. สร้างกลุ่มจากแม่แบบ (Recommended)**

```
1. คลิกแท็บ "กลุ่มแนะนำ"
2. เลือกกลุ่มที่ต้องการ (4 กลุ่ม):
   - เจ้าหน้าที่บัญชี (9 โมดูล)
   - กรรมการอาคารชุด (5 โมดูล)
   - ผู้ตรวจสอบบัญชี (4 โมดูล)
   - เจ้าหน้าที่ทั่วไป (4 โมดูล)
3. คลิก "สร้างกลุ่มนี้"
4. ✅ กลุ่มพร้อมสิทธิ์เริ่มต้นถูกสร้างทันที
```

### **2. สร้างกลุ่มใหม่ (Custom)**

```
1. คลิก "สร้างกลุ่มใหม่"
2. กรอกข้อมูล:
   - ชื่อกลุ่ม: "ทีมการเงิน"
   - คำอธิบาย: "ทีมการเงินและบัญชี"
3. คลิก "สร้างกลุ่ม"
4. ✅ กลุ่มถูกสร้าง (ยังไม่มีสิทธิ์)
5. คลิกปุ่ม [🛡] "กำหนดสิทธิ์"
6. เลือกโมดูลและสิทธิ์ที่ต้องการ
7. คลิก "บันทึกสิทธิ์"
```

### **3. กำหนดสิทธิ์ให้กลุ่ม**

```
1. เลือกกลุ่มที่ต้องการแก้ไข
2. คลิกปุ่ม [🛡] "กำหนดสิทธิ์"
3. เห็น Permission Matrix แบบละเอียด:

┌────────────────────────────────────────────────────────┐
│ ตารางสิทธิ์โมดูล                                       │
├────────────────────────────────────────────────────────┤
│ ▼ หลัก (9 โมดูล)                                      │
│   โมดูล           │เข้า│ดู│เพิ่ม│แก้│ลบ│พิมพ์│ส่งออก│ทั้งหมด│
│   ออกบิล           │ ✅ │✅│ ✅ │✅│❌│ ✅ │ ✅  │  ✅  │
│   การชำระเงิน      │ ✅ │✅│ ✅ │✅│❌│ ✅ │ ✅  │  ✅  │
│                                                         │
│ ▼ รายรับ (6 โมดูล)                                     │
│   บันทึกรายรับ     │ ✅ │✅│ ✅ │✅│❌│ ✅ │ ✅  │  ✅  │
│   สมุดรายวันรับ    │ ✅ │✅│ ✅ │✅│❌│ ✅ │ ✅  │  ✅  │
│                                                         │
│ ▶ บัญชี (5 โมดูล)                                      │
│ ▶ รายงาน (3 โมดูล)                                     │
└────────────────────────────────────────────────────────┘

4. เลือก Checkbox ตามสิทธิ์ที่ต้องการ
5. คลิก "บันทึกสิทธิ์"
6. ✅ สิทธิ์ถูกบันทึก
```

### **4. เพิ่มสมาชิกเข้ากลุ่ม**

```
1. เลือกกลุ่มที่ต้องการ
2. คลิกปุ่ม [👥] "จัดการสมาชิก"
3. เห็น Dialog 2 ส่วน:
   ┌─────────────────────────────────────────────┐
   │ สมาชิกปัจจุบัน (3 คน)│ผู้ใช้ที่เพิ่มได้ (12)│
   ├─────────────────────────────────────────────┤
   │ • John Account        │ ☐ Alice New          │
   │   john@...   [ลบ]     │ ☐ Bob Smith          │
   │ • Jane Doe            │ ☐ Charlie Lee        │
   │   jane@...   [ลบ]     │ ...                  │
   │ • Bob Finance         │ [เพิ่มทั้งหมด (0)]  │
   │   bob@...    [ลบ]     │                      │
   └─────────────────────────────────────────────┘
4. เลือก Checkbox ผู้ใช้ที่ต้องการเพิ่ม
5. คลิก "เพิ่มทั้งหมด (N)"
6. ✅ ผู้ใช้ถูกเพิ่มเข้ากลุ่มและได้สิทธิ์ทันที
```

### **5. ลบสมาชิกออกจากกลุ่ม**

```
1. เลือกกลุ่มที่ต้องการ
2. คลิกปุ่ม [👥] "จัดการสมาชิก"
3. ในส่วน "สมาชิกปัจจุบัน"
4. คลิกปุ่ม [ลบ] ข้างชื่อสมาชิก
5. ยืนยันการลบ
6. ✅ สมาชิกถูกลบออกจากกลุ่ม (สูญเสียสิทธิ์จากกลุ่มนั้น)
```

---

## 📋 4 กลุ่มแนะนำ (Predefined Groups)

### **1. เจ้าหน้าที่บัญชี (Accountant)**

**Base Role:** Staff  
**จำนวนโมดูล:** 9 โมดูล  
**จุดประสงค์:** บันทึกรายรับ-รายจ่าย สร้างบิล

**สิทธิ์:**
| โมดูล | เข้า | View | Add | Edit | Delete | Print | Export |
|------|:----:|:----:|:---:|:----:|:------:|:-----:|:------:|
| ออกบิล | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ | ✅ |
| การชำระเงิน | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ | ✅ |
| บันทึกรายรับ | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ | ✅ |
| บันทึกรายจ่าย | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ | ✅ |
| ผังบัญชี | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ | ✅ |
| สมุดรายวัน | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ | ✅ |
| สมุดบัญชีแยกประเภท | ✅ | ✅ | ❌ | ❌ | ❌ | ✅ | ✅ |
| รายงานทางการเงิน | ✅ | ✅ | ❌ | ❌ | ❌ | ✅ | ✅ |
| รายงาน | ✅ | ✅ | ❌ | ❌ | ❌ | ✅ | ✅ |

**สรุป:** บันทึกได้ แต่ไม่ลบ, ดูรายงานและงบ (Read-only)

---

### **2. กรรมการอาคารชุด (Committee)**

**Base Role:** Resident  
**จำนวนโมดูล:** 5 โมดูล  
**จุดประสงค์:** ตรวจสอบรายงานและงบการเงิน

**สิทธิ์:**
| โมดูล | เข้า | View | Add | Edit | Delete | Print | Export |
|------|:----:|:----:|:---:|:----:|:------:|:-----:|:------:|
| รายงาน | ✅ | ✅ | ❌ | ❌ | ❌ | ✅ | ✅ |
| รายงานทางการเงิน | ✅ | ✅ | ❌ | ❌ | ❌ | ✅ | ✅ |
| รายงานรายรับ | ✅ | ✅ | ❌ | ❌ | ❌ | ✅ | ✅ |
| รายงานงบประมาณ | ✅ | ✅ | ❌ | ❌ | ❌ | ✅ | ✅ |
| การวิเคราะห์ข้อมูล | ✅ | ✅ | ❌ | ❌ | ❌ | ✅ | ✅ |

**สรุป:** ดูได้อย่างเดียว (Read-only) + พิมพ์/ส่งออกรายงาน

---

### **3. ผู้ตรวจสอบบัญชี (Auditor)**

**Base Role:** Resident  
**จำนวนโมดูล:** 4 โมดูล  
**จุดประสงค์:** ตรวจสอบบัญชีภายนอก

**สิทธิ์:**
| โมดูล | เข้า | View | Add | Edit | Delete | Print | Export |
|------|:----:|:----:|:---:|:----:|:------:|:-----:|:------:|
| รายงานทางการเงิน | ✅ | ✅ | ❌ | ❌ | ❌ | ✅ | ✅ |
| สมุดบัญชีแยกประเภท | ✅ | ✅ | ❌ | ❌ | ❌ | ✅ | ✅ |
| สมุดรายวัน | ✅ | ✅ | ❌ | ❌ | ❌ | ✅ | ❌ |
| ผังบัญชี | ✅ | ✅ | ❌ | ❌ | ❌ | ✅ | ❌ |

**สรุป:** เข้าถึงงบการเงินเท่านั้น (Read-only) + พิมพ์ได้ ส่งออกบางอย่างไม่ได้

---

### **4. เจ้าหน้าที่ทั่วไป (Support Staff)**

**Base Role:** Staff  
**จำนวนโมดูล:** 4 โมดูล  
**จุดประสงค์:** งานปฏิบัติการ (ไม่เกี่ยวบัญชี)

**สิทธิ์:**
| โมดูล | เข้า | View | Add | Edit | Delete | Print | Export |
|------|:----:|:----:|:---:|:----:|:------:|:-----:|:------:|
| จัดการพัสดุ | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ | ✅ |
| งานแจ้งซ่อม | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ | ✅ |
| ประกาศ | ✅ | ✅ | ✅ | ✅ | ❌ | ✅ | ❌ |
| เอกสารและไฟล์ | ✅ | ✅ | ✅ | ✅ | ❌ | ❌ | ✅ |

**สรุป:** เข้าถึงเฉพาะโมดูลปฏิบัติการ ไม่เห็นโมดูลบัญชีเลย

---

## 🎯 Use Cases (ตัวอย่างการใช้งาน)

### **Case 1: เพิ่มทีมบัญชีใหม่ 5 คน**

```
สถานการณ์: บริษัทจ้างเจ้าหน้าที่บัญชีใหม่ 5 คน

Before (ไม่มี User Groups):
  1. เพิ่ม User 1 → ตั้งสิทธิ์ 9 โมดูล
  2. เพิ่ม User 2 → ตั้งสิทธิ์ 9 โมดูล
  3. เพิ่ม User 3 → ตั้งสิทธิ์ 9 โมดูล
  4. เพิ่ม User 4 → ตั้งสิทธิ์ 9 โมดูล
  5. เพิ่ม User 5 → ตั้งสิทธิ์ 9 โมดูล
  = 45 การตั้งค่า ❌

After (มี User Groups):
  1. สร้างกลุ่ม "เจ้าหน้าที่บัญชี" จากแม่แบบ (1 คลิก)
  2. เพิ่มสมาชิก 5 คนเข้ากลุ่ม (1 ครั้ง)
  = 2 การตั้งค่า ✅
```

---

### **Case 2: แก้ไขสิทธิ์กลุ่มบัญชี**

```
สถานการณ์: ต้องการเพิ่มสิทธิ์ "สมุดเงินฝาก" ให้เจ้าหน้าที่บัญชีทั้งหมด

Before (ไม่มี User Groups):
  1. แก้ไขสิทธิ์ User 1
  2. แก้ไขสิทธิ์ User 2
  3. แก้ไขสิทธิ์ User 3
  4. แก้ไขสิทธิ์ User 4
  5. แก้ไขสิทธิ์ User 5
  = 5 ครั้ง ❌

After (มี User Groups):
  1. แก้ไขสิทธิ์กลุ่ม "เจ้าหน้าที่บัญชี"
  2. เพิ่มโมดูล "สมุดเงินฝาก"
  3. บันทึก
  = 1 ครั้ง → ทุกคนในกลุ่มได้สิทธิ์ทันที ✅
```

---

### **Case 3: กรรมการอาคารเข้ามาใหม่**

```
สถานการณ์: นาย A (Resident ห้อง 505) ได้รับเลือกเป็นกรรมการอาคาร

Workflow:
  1. นาย A เป็น Resident อยู่แล้ว (มีสิทธิ์ดูข้อมูลห้องตนเอง)
  2. เข้า "กลุ่มผู้ใช้งาน"
  3. เลือกกลุ่ม "กรรมการอาคารชุด"
  4. คลิก "จัดการสมาชิก"
  5. เลือก "นาย A (505)"
  6. เพิ่มเข้ากลุ่ม
  ✅ นาย A ได้สิทธิ์เพิ่มเติม:
     - ดูรายงานทางการเงิน
     - ดูการวิเคราะห์ข้อมูล
     - พิมพ์/ส่งออกรายงาน
     + ยังคงเป็น Resident (ดูข้อมูลห้อง 505)
```

---

### **Case 4: Auditor ภายนอกมาตรวจสอบบัญชี**

```
สถานการณ์: จ้าง Auditor ภายนอกมาตรวจสอบบัญชีประจำปี

Workflow:
  1. เพิ่ม User ชั่วคราว:
     - Email: auditor@external.com
     - ชื่อ: External Auditor
     - Role: Resident (ไม่มีห้อง)
  2. เพิ่มเข้ากลุ่ม "ผู้ตรวจสอบบัญชี"
  ✅ Auditor ได้สิทธิ์:
     - เข้า 4 โมดูลงบการเงิน
     - ดูอย่างเดียว (Read-only)
     - พิมพ์งบได้
     
  หลังตรวจสอบเสร็จ:
  → ลบออกจากกลุ่ม หรือ ปิดใช้งาน account
```

---

## 📊 สรุปประโยชน์

### **1. Flexibility (ยืดหยุ่น)**
```
✅ สร้างกลุ่มตามหน้าที่จริง
✅ กำหนดสิทธิ์แบบละเอียด (40+ โมดูล × 7 actions)
✅ เพิ่ม/ลบสมาชิกได้ง่าย
✅ สมาชิกคนเดียวอยู่ได้หลายกลุ่ม
```

### **2. Consistency (สม่ำเสมอ)**
```
✅ ทุกคนในกลุ่มได้สิทธิ์เหมือนกัน
✅ ไม่ต้องตั้งสิทธิ์ทีละคน
✅ ลด human error
✅ ง่ายต่อการ audit
```

### **3. Scalability (ขยายได้)**
```
✅ เพิ่ม user ใหม่ → เพิ่มเข้ากลุ่ม → ได้สิทธิ์ทันที
✅ แก้สิทธิ์กลุ่ม → members ทุกคนได้สิทธิ์ใหม่
✅ รองรับองค์กรขนาดใหญ่
✅ รองรับหลายโครงการ
```

### **4. Simplicity (ง่าย)**
```
✅ UI ใช้งานง่าย
✅ มีกลุ่มแนะนำ 4 กลุ่มพร้อมใช้
✅ Permission Matrix แบบ visual
✅ ค้นหาและกรองสมาชิกได้
```

---

## 🔐 ความปลอดภัย

### **การกำหนดสิทธิ์แบบชั้น (Layered)**

```
User Permissions = Base Role + User Groups

ตัวอย่าง:
  User: นาย A
  Base Role: Resident
    └─ สิทธิ์: ดูข้อมูลห้องตนเอง, ชำระบิล
  
  User Groups: "กรรมการอาคารชุด"
    └─ สิทธิ์เพิ่ม: ดูรายงานทางการเงิน, ดู Analytics
  
  = สิทธิ์รวม: Base Role + User Groups
```

### **Audit Trail**

```
✅ บันทึกการสร้างกลุ่ม
✅ บันทึกการแก้ไขสิทธิ์
✅ บันทึกการเพิ่ม/ลบสมาชิก
✅ รู้ว่าใครทำอะไรเมื่อไหร่
```

---

## 📁 ไฟล์ที่สร้าง

1. **Database Schema:**
   - `scripts/014_user_groups.sql` - Tables, RLS, initial data

2. **TypeScript Types:**
   - `lib/types/user-groups.ts` - Interfaces & predefined groups

3. **Server Actions:**
   - `lib/actions/user-group-actions.ts` - CRUD operations

4. **Components:**
   - `components/permission-matrix.tsx` - Permission matrix UI
   - `components/group-assignment-dialog.tsx` - Member management

5. **Pages:**
   - `app/(admin)/user-groups/page.tsx` - Main UI

6. **Permissions:**
   - `lib/types/granular-permissions.ts` - Updated with `user_groups` module

7. **Sidebar:**
   - `components/protected-sidebar.tsx` - Added "กลุ่มผู้ใช้งาน" menu

---

## 🧪 การทดสอบ

### **Test 1: สร้างกลุ่มจากแม่แบบ**
```
1. สลับเป็น "Super Admin"
2. เข้า "กลุ่มผู้ใช้งาน"
3. คลิกแท็บ "กลุ่มแนะนำ"
4. คลิก "สร้างกลุ่มนี้" ที่ "เจ้าหน้าที่บัญชี"
5. ✅ ควรเห็นกลุ่มใหม่ในแท็บ "กลุ่มทั้งหมด"
6. คลิก [🛡] "กำหนดสิทธิ์"
7. ✅ ควรเห็น 9 โมดูลที่มีสิทธิ์อยู่แล้ว
```

### **Test 2: เพิ่มสมาชิกเข้ากลุ่ม**
```
1. เข้า "กลุ่มผู้ใช้งาน"
2. เลือกกลุ่ม "เจ้าหน้าที่บัญชี"
3. คลิก [👥] "จัดการสมาชิก"
4. เลือก User ที่ต้องการเพิ่ม
5. คลิก "เพิ่มทั้งหมด"
6. ✅ ควรเห็น User ในส่วน "สมาชิกปัจจุบัน"
7. ✅ User ควรได้สิทธิ์เข้าโมดูลบัญชี
```

### **Test 3: แก้ไขสิทธิ์กลุ่ม**
```
1. เข้า "กลุ่มผู้ใช้งาน"
2. เลือกกลุ่ม "เจ้าหน้าที่ทั่วไป"
3. คลิก [🛡] "กำหนดสิทธิ์"
4. เพิ่มสิทธิ์ "ประกาศ" → Export = ✅
5. บันทึก
6. ✅ สมาชิกทุกคนควรได้สิทธิ์ Export ประกาศทันที
```

---

## ✨ Features

### **Predefined Groups**
- ✅ 4 กลุ่มแนะนำพร้อมใช้
- ✅ สิทธิ์เริ่มต้นตามหน้าที่
- ✅ สร้างได้ 1 คลิก

### **Permission Matrix**
- ✅ UI แบบ visual
- ✅ จัดกลุ่มตามหมวดหมู่
- ✅ Expand/Collapse categories
- ✅ "ทั้งหมด" checkbox
- ✅ Real-time update

### **Group Assignment**
- ✅ 2-panel design
- ✅ Search & filter
- ✅ Bulk add
- ✅ Quick remove
- ✅ Real-time member count

### **Responsive**
- ✅ Desktop-optimized
- ✅ Large dialogs สำหรับ Permission Matrix
- ✅ Scrollable areas

---

## 🚀 ต่อไป (Future Enhancements)

1. **Group Inheritance:** กลุ่มลูกสืบทอดสิทธิ์จากกลุ่มแม่
2. **Time-based Permissions:** สิทธิ์มีอายุ (เช่น Auditor 30 วัน)
3. **Approval Workflow:** การเปลี่ยนสิทธิ์ต้องอนุมัติ
4. **Permission Templates:** บันทึก template สิทธิ์
5. **Bulk Operations:** เพิ่ม/ลบสมาชิกจาก CSV

---

## 🎊 สรุป

### **ระบบ User Groups ครบถ้วนแล้ว!**

✅ **Database:** Tables, RLS, Triggers  
✅ **Types:** Interfaces, Predefined configs  
✅ **Actions:** Full CRUD operations  
✅ **Components:** Permission Matrix, Group Assignment  
✅ **UI:** Complete management page  
✅ **Permissions:** Integrated with granular permissions  
✅ **Sidebar:** Menu added for Super/Company/Project Admin  

**พร้อมใช้งานได้เลย!** 🎯

---

## 📞 คำถามที่พบบ่อย

**Q: User สามารถอยู่หลายกลุ่มได้ไหม?**  
A: ได้! User จะได้สิทธิ์รวมจากทุกกลุ่มที่อยู่

**Q: ถ้า User มีสิทธิ์ทั้งจาก Base Role และ User Group?**  
A: สิทธิ์จะรวมกัน (Union) → ได้สิทธิ์มากขึ้น

**Q: ลบกลุ่มแล้วสมาชิกเป็นอย่างไร?**  
A: สมาชิกยังอยู่ แต่สูญเสียสิทธิ์จากกลุ่มนั้น

**Q: แก้ไขสิทธิ์กลุ่ม มีผลทันทีไหม?**  
A: ทันที! สมาชิกทุกคนได้สิทธิ์ใหม่ทันที

**ลองใช้งานได้เลย! 🚀**
